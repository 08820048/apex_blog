# ApexBlog 后台管理接口文档

## 基本信息

- **基础URL**: `http://localhost:8888/api`
- **API版本**: v1.0
- **数据格式**: JSON
- **字符编码**: UTF-8
- **认证方式**: JWT Bearer Token（所有接口都需要认证）
- **最后更新**: 2025-08-22（安全修复版本）

## 🔒 安全更新说明

**重要**: 本次更新包含重要的安全修复，所有管理员操作现在都有严格的权限验证。

### 安全增强功能
- ✅ 方法级权限验证：所有管理员操作都需要 `ADMIN` 角色
- ✅ 安全审计日志：记录所有敏感操作
- ✅ 访问控制过滤器：实时监控管理员API访问
- ✅ 权限分离：管理员和普通用户使用不同的数据访问方法

## 通用响应格式

所有接口都使用统一的响应格式：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1691740800000
}
```

### 响应状态码

| 状态码 | 说明 | 安全说明 |
|--------|------|----------|
| 200 | 请求成功 | - |
| 400 | 请求参数错误 | - |
| 401 | 未授权，需要登录 | 🔒 Token无效或已过期，需要重新登录 |
| 403 | 禁止访问，权限不足 | 🔒 **新增**：缺少ADMIN角色权限 |
| 404 | 资源不存在 | - |
| 429 | 请求过于频繁 | 🔒 **新增**：触发限流保护 |
| 500 | 服务器内部错误 | - |

### 🚨 权限错误处理

当遇到权限相关错误时，前端应该：

1. **401 未授权**：
   - 清除本地存储的token
   - 跳转到登录页面
   - 提示用户重新登录

2. **403 权限不足**：
   - 显示权限不足提示
   - 不要自动跳转登录页
   - 检查用户角色是否为ADMIN

3. **429 请求频繁**：
   - 显示"请求过于频繁"提示
   - 实施客户端限流
   - 延迟后重试

## 🔐 权限要求总览

| 接口分类 | 权限要求 | 说明 |
|---------|---------|------|
| 认证接口 (`/auth/*`) | 无 | 公开接口 |
| 用户管理 (`/admin/user/*`) | 🔒 ADMIN | 用户信息和密码管理 |
| 文章管理 (`/admin/articles/*`) | 🔒 ADMIN | 所有操作需要管理员权限 |
| 分类管理 (`/admin/categories/*`) | 🔒 ADMIN | 所有操作需要管理员权限 |
| 标签管理 (`/admin/tags/*`) | 🔒 ADMIN | 所有操作需要管理员权限 |
| 文件上传 (`/admin/upload/*`) | 🔒 ADMIN | 所有操作需要管理员权限 |
| 安全监控 (`/admin/security/*`) | 🔒 ADMIN | 所有操作需要管理员权限 |

## 认证说明

### 登录接口

**接口**: `POST /auth/login`

**请求参数**:
```json
{
  "username": "xuyi",
  "password": "5247xff"
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzM4NCJ9...",
    "tokenType": "Bearer",
    "user": {
      "id": 1,
      "username": "xuyi",
      "email": "xuyi@example.com",
      "nickname": "Xuyi",
      "bio": "全栈开发工程师，专注于Java和前端技术"
    }
  },
  "timestamp": 1754978026357
}
```

**说明**:
- 登录接口不需要认证
- 成功登录后获得JWT token，有效期24小时
- 需要保存token用于后续API调用

### Token使用

所有管理后台接口都需要在请求头中携带JWT token：

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## 分页响应格式

分页接口的 `data` 字段格式：

```json
{
  "content": [],
  "page": 0,
  "size": 10,
  "totalElements": 100,
  "totalPages": 10,
  "first": true,
  "last": false,
  "hasNext": true,
  "hasPrevious": false
}
```

## 文章管理

🔒 **安全更新**: 所有文章管理接口现在都有严格的权限验证，只有具备 `ADMIN` 角色的用户才能访问。

### 获取所有文章（包括草稿）

**接口**: `GET /admin/articles`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**请求参数**:
- `page` (int, 可选): 页码，默认0
- `size` (int, 可选): 每页大小，默认10

**响应数据**: 分页的文章摘要列表（包括草稿状态的文章）

### 获取文章详情

**接口**: `GET /admin/articles/{id}`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**路径参数**:
- `id` (long): 文章ID

**响应数据**: 完整的文章对象

**🔒 安全说明**:
- 管理员可以访问所有状态的文章（包括草稿、已发布、已归档）
- 此操作会记录在安全审计日志中
- 与前台接口 `/articles/{id}` 不同，此接口无状态限制

### 创建文章

**接口**: `POST /admin/articles`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**请求参数**:
```json
{
  "title": "文章标题",
  "summary": "文章摘要",
  "content": "文章内容（Markdown格式）",
  "coverImage": "http://example.com/cover.jpg",
  "categoryId": 1,
  "status": "DRAFT",
  "isTop": false,
  "tagNames": ["Java", "Spring Boot"]
}
```

**字段说明**:
- `title`: 文章标题（必需，最大200字符）
- `summary`: 文章摘要（可选）
- `content`: 文章内容（必需，支持Markdown）
- `coverImage`: 封面图片URL（可选）
- `categoryId`: 分类ID（可选）
- `status`: 文章状态，可选值：`DRAFT`（草稿）、`PUBLISHED`（已发布）
- `isTop`: 是否置顶（可选，默认false）
- `tagNames`: 标签名称数组（可选）

**响应数据**: 创建的文章对象

### 更新文章

**接口**: `PUT /admin/articles/{id}`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**路径参数**:
- `id` (long): 文章ID

**请求参数**: 同创建文章

**响应数据**: 更新后的文章对象

### 删除文章

**接口**: `DELETE /admin/articles/{id}`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**路径参数**:
- `id` (long): 文章ID

**响应数据**: 无

### 发布文章

**接口**: `PUT /admin/articles/{id}/publish`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**路径参数**:
- `id` (long): 文章ID

**响应数据**: 更新后的文章对象

**🔒 安全说明**:
- 此操作会记录在安全审计日志中
- 发布后会自动发送邮件通知订阅者

### 取消发布文章

**接口**: `PUT /admin/articles/{id}/unpublish`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**路径参数**:
- `id` (long): 文章ID

**响应数据**: 更新后的文章对象

**🔒 安全说明**: 此操作会记录在安全审计日志中

## 分类管理

🔒 **安全更新**: 所有分类管理接口现在都需要 `ADMIN` 角色权限。

### 获取所有分类

**接口**: `GET /admin/categories`

**权限要求**: 🔒 需要 `ADMIN` 角色

**请求头**: `Authorization: Bearer {token}`

**响应数据**: 分类列表

### 获取分类详情

**接口**: `GET /admin/categories/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 分类ID

**响应数据**: 分类对象

### 创建分类

**接口**: `POST /admin/categories`

**请求头**: `Authorization: Bearer {token}`

**请求参数**:
```json
{
  "name": "分类名称",
  "description": "分类描述",
  "sortOrder": 1
}
```

**字段说明**:
- `name`: 分类名称（必需，最大50字符）
- `description`: 分类描述（可选）
- `sortOrder`: 排序顺序（可选，默认0）

**响应数据**: 创建的分类对象

### 更新分类

**接口**: `PUT /admin/categories/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 分类ID

**请求参数**: 同创建分类

**响应数据**: 更新后的分类对象

### 删除分类

**接口**: `DELETE /admin/categories/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 分类ID

**响应数据**: 无

## 标签管理

🔒 **安全更新**: 所有标签管理接口现在都需要 `ADMIN` 角色权限。

### 获取所有标签

**接口**: `GET /admin/tags`

**权限要求**: 🔒 需要 `ADMIN` 角色

**请求头**: `Authorization: Bearer {token}`

**响应数据**: 标签列表

### 获取标签详情

**接口**: `GET /admin/tags/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 标签ID

**响应数据**: 标签对象

### 创建标签

**接口**: `POST /admin/tags`

**请求头**: `Authorization: Bearer {token}`

**请求参数**:
```json
{
  "name": "标签名称",
  "color": "#007396"
}
```

**字段说明**:
- `name`: 标签名称（必需，最大30字符）
- `color`: 标签颜色（可选，十六进制颜色值）

**响应数据**: 创建的标签对象

### 更新标签

**接口**: `PUT /admin/tags/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 标签ID

**请求参数**: 同创建标签

**响应数据**: 更新后的标签对象

### 删除标签

**接口**: `DELETE /admin/tags/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 标签ID

**响应数据**: 无

## 作品集管理

### 获取所有作品集

**接口**: `GET /admin/portfolios`

**请求头**: `Authorization: Bearer {token}`

**响应数据**: 作品集列表

### 获取作品集详情

**接口**: `GET /admin/portfolios/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 作品集ID

**响应数据**: 作品集对象

### 创建作品集

**接口**: `POST /admin/portfolios`

**请求头**: `Authorization: Bearer {token}`

**请求参数**:
```json
{
  "name": "项目名称",
  "description": "项目描述",
  "url": "https://github.com/user/project",
  "coverImage": "http://example.com/cover.jpg",
  "technologies": "Java, Spring Boot, Vue.js",
  "sortOrder": 1,
  "isFeatured": true
}
```

**字段说明**:
- `name`: 项目名称（必需，最大100字符）
- `description`: 项目描述（可选）
- `url`: 项目链接（可选）
- `coverImage`: 封面图片URL（可选）
- `technologies`: 技术栈（可选，最大500字符）
- `sortOrder`: 排序顺序（可选，默认0）
- `isFeatured`: 是否精选（可选，默认false）

**响应数据**: 创建的作品集对象

### 更新作品集

**接口**: `PUT /admin/portfolios/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 作品集ID

**请求参数**: 同创建作品集

**响应数据**: 更新后的作品集对象

### 删除作品集

**接口**: `DELETE /admin/portfolios/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 作品集ID

**响应数据**: 无

## 友链管理

### 获取所有友链

**接口**: `GET /admin/friend-links`

**请求头**: `Authorization: Bearer {token}`

**响应数据**: 友链列表

### 获取友链详情

**接口**: `GET /admin/friend-links/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 友链ID

**响应数据**: 友链对象

### 创建友链

**接口**: `POST /admin/friend-links`

**请求头**: `Authorization: Bearer {token}`

**请求参数**:
```json
{
  "name": "友站名称",
  "url": "https://example.com",
  "avatar": "http://example.com/avatar.jpg",
  "description": "友站描述",
  "sortOrder": 1,
  "isActive": true
}
```

**字段说明**:
- `name`: 友站名称（必需，最大50字符）
- `url`: 友站链接（必需）
- `avatar`: 友站头像URL（可选）
- `description`: 友站描述（可选，最大200字符）
- `sortOrder`: 排序顺序（可选，默认0）
- `isActive`: 是否激活（可选，默认true）

**响应数据**: 创建的友链对象

### 更新友链

**接口**: `PUT /admin/friend-links/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 友链ID

**请求参数**: 同创建友链

**响应数据**: 更新后的友链对象

### 删除友链

**接口**: `DELETE /admin/friend-links/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 友链ID

**响应数据**: 无

## 邮箱订阅管理

### 获取所有订阅者

**接口**: `GET /admin/email-subscribers`

**请求头**: `Authorization: Bearer {token}`

**请求参数**:
- `page` (int, 可选): 页码，默认0
- `size` (int, 可选): 每页大小，默认10

**响应数据**: 分页的订阅者列表

### 删除订阅者

**接口**: `DELETE /admin/email-subscribers/{id}`

**请求头**: `Authorization: Bearer {token}`

**路径参数**:
- `id` (long): 订阅者ID

**响应数据**: 无

## 访问统计

### 获取访问统计

**接口**: `GET /admin/stats/visits`

**请求头**: `Authorization: Bearer {token}`

**响应数据**:
```json
{
  "totalVisits": 10000,
  "todayVisits": 100,
  "uniqueVisitors": 5000,
  "totalArticles": 50,
  "recentVisits": [
    {
      "date": "2024-01-01",
      "visits": 100
    }
  ],
  "popularPages": [
    {
      "uri": "/articles/1",
      "visits": 500
    }
  ]
}
```

## 错误处理

### 常见错误响应

**认证失败** (401):
```json
{
  "code": 401,
  "message": "未授权，请先登录",
  "data": null,
  "timestamp": 1691740800000
}
```

**权限不足** (403):
```json
{
  "code": 403,
  "message": "权限不足，需要管理员权限",
  "data": null,
  "timestamp": 1691740800000
}
```

**参数验证错误** (400):
```json
{
  "code": 400,
  "message": "参数验证失败",
  "data": {
    "field": "title",
    "message": "文章标题不能为空"
  },
  "timestamp": 1691740800000
}
```

**资源不存在** (404):
```json
{
  "code": 404,
  "message": "文章不存在",
  "data": null,
  "timestamp": 1691740800000
}
```

## 后台管理使用示例

### 登录API

```javascript
// api/auth.js
import axios from 'axios'

const authApi = axios.create({
  baseURL: 'http://localhost:8888/api',
  timeout: 10000
})

export const login = async (username, password) => {
  try {
    const response = await authApi.post('/auth/login', {
      username,
      password
    })

    if (response.data.code === 200) {
      // 保存token到localStorage
      localStorage.setItem('admin_token', response.data.data.token)
      return response.data
    } else {
      throw new Error(response.data.message || '登录失败')
    }
  } catch (error) {
    throw new Error(error.response?.data?.message || '网络错误')
  }
}

export const logout = () => {
  localStorage.removeItem('admin_token')
  window.location.href = '/admin/login'
}
```

### Axios 配置

```javascript
// api/config.js
import axios from 'axios'

// 创建axios实例
const api = axios.create({
  baseURL: 'http://localhost:8888/api',
  timeout: 10000
})

// 请求拦截器 - 添加token
api.interceptors.request.use(
  config => {
    const token = localStorage.getItem('admin_token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  error => {
    return Promise.reject(error)
  }
)

// 响应拦截器 - 统一处理错误
api.interceptors.response.use(
  response => {
    const { data } = response
    if (data.code === 200) {
      return data
    } else {
      throw new Error(data.message || '请求失败')
    }
  },
  error => {
    if (error.response?.status === 401) {
      // token过期，跳转到登录页
      localStorage.removeItem('admin_token')
      window.location.href = '/admin/login'
    } else if (error.response?.status === 403) {
      throw new Error('权限不足')
    } else {
      throw new Error(error.response?.data?.message || '网络错误')
    }
  }
)

export default api
```

### 登录组件示例

```javascript
// components/Login.jsx (React)
import React, { useState } from 'react'
import { login } from '../api/auth'

const Login = ({ onLoginSuccess }) => {
  const [form, setForm] = useState({
    username: '',
    password: ''
  })
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)
    setError('')

    try {
      const response = await login(form.username, form.password)
      alert('登录成功')
      onLoginSuccess?.(response.data)
    } catch (error) {
      setError(error.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="login-form">
      <h2>管理员登录</h2>

      <form onSubmit={handleSubmit}>
        <div>
          <label>用户名:</label>
          <input
            type="text"
            value={form.username}
            onChange={(e) => setForm(prev => ({
              ...prev,
              username: e.target.value
            }))}
            required
          />
        </div>

        <div>
          <label>密码:</label>
          <input
            type="password"
            value={form.password}
            onChange={(e) => setForm(prev => ({
              ...prev,
              password: e.target.value
            }))}
            required
          />
        </div>

        {error && <div className="error">{error}</div>}

        <button type="submit" disabled={loading}>
          {loading ? '登录中...' : '登录'}
        </button>
      </form>
    </div>
  )
}

export default Login
```

### 文章管理API

```javascript
// api/article.js
import api from './config'

export const articleApi = {
  // 获取文章列表
  getList: (page = 0, size = 10) => 
    api.get(`/admin/articles?page=${page}&size=${size}`),
  
  // 获取文章详情
  getDetail: (id) => 
    api.get(`/admin/articles/${id}`),
  
  // 创建文章
  create: (data) => 
    api.post('/admin/articles', data),
  
  // 更新文章
  update: (id, data) => 
    api.put(`/admin/articles/${id}`, data),
  
  // 删除文章
  delete: (id) => 
    api.delete(`/admin/articles/${id}`),
  
  // 发布文章
  publish: (id) => 
    api.put(`/admin/articles/${id}/publish`),
  
  // 取消发布
  unpublish: (id) => 
    api.put(`/admin/articles/${id}/unpublish`)
}
```

### React 管理组件示例

```javascript
// components/ArticleManager.jsx
import React, { useState, useEffect } from 'react'
import { articleApi } from '../api/article'

const ArticleManager = () => {
  const [articles, setArticles] = useState([])
  const [loading, setLoading] = useState(false)
  const [pagination, setPagination] = useState({
    page: 0,
    size: 10,
    total: 0
  })
  
  // 获取文章列表
  const fetchArticles = async (page = 0) => {
    setLoading(true)
    try {
      const response = await articleApi.getList(page, pagination.size)
      setArticles(response.data.content)
      setPagination(prev => ({
        ...prev,
        page: response.data.page,
        total: response.data.totalElements
      }))
    } catch (error) {
      console.error('获取文章失败:', error)
      alert(error.message)
    } finally {
      setLoading(false)
    }
  }
  
  // 发布文章
  const handlePublish = async (id) => {
    try {
      await articleApi.publish(id)
      alert('文章发布成功')
      fetchArticles(pagination.page)
    } catch (error) {
      console.error('发布文章失败:', error)
      alert(error.message)
    }
  }
  
  // 删除文章
  const handleDelete = async (id) => {
    if (!confirm('确定要删除这篇文章吗？')) return
    
    try {
      await articleApi.delete(id)
      alert('文章删除成功')
      fetchArticles(pagination.page)
    } catch (error) {
      console.error('删除文章失败:', error)
      alert(error.message)
    }
  }
  
  useEffect(() => {
    fetchArticles()
  }, [])
  
  return (
    <div className="article-manager">
      <h2>文章管理</h2>
      
      {loading ? (
        <div>加载中...</div>
      ) : (
        <div>
          <table>
            <thead>
              <tr>
                <th>标题</th>
                <th>状态</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {articles.map(article => (
                <tr key={article.id}>
                  <td>{article.title}</td>
                  <td>{article.status}</td>
                  <td>{new Date(article.createdAt).toLocaleDateString()}</td>
                  <td>
                    {article.status === 'DRAFT' && (
                      <button onClick={() => handlePublish(article.id)}>
                        发布
                      </button>
                    )}
                    <button onClick={() => handleDelete(article.id)}>
                      删除
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          
          {/* 分页组件 */}
          <div className="pagination">
            <button 
              disabled={pagination.page === 0}
              onClick={() => fetchArticles(pagination.page - 1)}
            >
              上一页
            </button>
            <span>第 {pagination.page + 1} 页</span>
            <button 
              disabled={pagination.page >= Math.ceil(pagination.total / pagination.size) - 1}
              onClick={() => fetchArticles(pagination.page + 1)}
            >
              下一页
            </button>
          </div>
        </div>
      )}
    </div>
  )
}

export default ArticleManager
```

### Vue 3 管理组件示例

```javascript
// components/ArticleManager.vue
<template>
  <div class="article-manager">
    <h2>文章管理</h2>
    
    <div v-if="loading">加载中...</div>
    
    <div v-else>
      <table>
        <thead>
          <tr>
            <th>标题</th>
            <th>状态</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="article in articles" :key="article.id">
            <td>{{ article.title }}</td>
            <td>{{ article.status }}</td>
            <td>{{ formatDate(article.createdAt) }}</td>
            <td>
              <button 
                v-if="article.status === 'DRAFT'"
                @click="handlePublish(article.id)"
              >
                发布
              </button>
              <button @click="handleDelete(article.id)">
                删除
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      
      <!-- 分页 -->
      <div class="pagination">
        <button 
          :disabled="pagination.page === 0"
          @click="fetchArticles(pagination.page - 1)"
        >
          上一页
        </button>
        <span>第 {{ pagination.page + 1 }} 页</span>
        <button 
          :disabled="pagination.page >= totalPages - 1"
          @click="fetchArticles(pagination.page + 1)"
        >
          下一页
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { articleApi } from '../api/article'

const articles = ref([])
const loading = ref(false)
const pagination = reactive({
  page: 0,
  size: 10,
  total: 0
})

const totalPages = computed(() => 
  Math.ceil(pagination.total / pagination.size)
)

// 获取文章列表
const fetchArticles = async (page = 0) => {
  loading.value = true
  try {
    const response = await articleApi.getList(page, pagination.size)
    articles.value = response.data.content
    pagination.page = response.data.page
    pagination.total = response.data.totalElements
  } catch (error) {
    console.error('获取文章失败:', error)
    ElMessage.error(error.message)
  } finally {
    loading.value = false
  }
}

// 发布文章
const handlePublish = async (id) => {
  try {
    await articleApi.publish(id)
    ElMessage.success('文章发布成功')
    fetchArticles(pagination.page)
  } catch (error) {
    console.error('发布文章失败:', error)
    ElMessage.error(error.message)
  }
}

// 删除文章
const handleDelete = async (id) => {
  try {
    await ElMessageBox.confirm('确定要删除这篇文章吗？', '提示')
    await articleApi.delete(id)
    ElMessage.success('文章删除成功')
    fetchArticles(pagination.page)
  } catch (error) {
    if (error !== 'cancel') {
      console.error('删除文章失败:', error)
      ElMessage.error(error.message)
    }
  }
}

// 格式化日期
const formatDate = (dateString) => {
  return new Date(dateString).toLocaleDateString()
}

onMounted(() => {
  fetchArticles()
})
</script>
```

## 👤 用户管理

🔒 **安全更新**: 所有用户管理接口现在都需要 `ADMIN` 角色权限。

### 获取当前用户信息

**接口**: `GET /admin/user/profile`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**响应数据**:
```json
{
  "id": 1,
  "username": "xuyi",
  "email": "xuyi@example.com",
  "nickname": "管理员",
  "bio": "博客管理员",
  "avatar": "http://example.com/avatar.jpg",
  "createdAt": "2024-01-01T00:00:00",
  "updatedAt": "2024-01-01T00:00:00"
}
```

### 修改密码

**接口**: `PUT /admin/user/change-password`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**请求参数**:
```json
{
  "currentPassword": "当前密码",
  "newPassword": "新密码",
  "confirmPassword": "确认新密码"
}
```

**字段说明**:
- `currentPassword`: 当前密码（必需）
- `newPassword`: 新密码（必需，6-50个字符）
- `confirmPassword`: 确认新密码（必需，必须与新密码一致）

**响应数据**: 操作成功消息

**🔒 安全说明**:
- 此操作会记录在安全审计日志中
- 新密码不能与当前密码相同
- 密码修改后建议重新登录

**错误情况**:
- `400`: 当前密码错误
- `400`: 新密码和确认密码不一致
- `400`: 新密码与当前密码相同

## 🔒 安全监控接口

### 获取安全统计信息

**接口**: `GET /admin/security/stats`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**响应数据**:
```json
{
  "suspiciousIpCount": 5,
  "totalMaliciousRequests": 23,
  "highRiskIps": 2,
  "lastCleanupTime": "2025-08-22T10:30:00"
}
```

### 清理安全记录

**接口**: `POST /admin/security/cleanup`

**请求头**: `Authorization: Bearer {token}`

**权限要求**: 🔒 需要 `ADMIN` 角色

**响应数据**: 操作成功消息

## 🔧 前端集成指南

### 权限错误处理

```javascript
// 推荐的错误处理方式
const handleApiError = (error) => {
  const { status, data } = error.response || {};

  switch (status) {
    case 401:
      // Token无效或过期
      localStorage.removeItem('token');
      router.push('/login');
      message.error('登录已过期，请重新登录');
      break;

    case 403:
      // 权限不足
      message.error('权限不足，需要管理员权限');
      break;

    case 429:
      // 请求过于频繁
      message.error('请求过于频繁，请稍后再试');
      break;

    default:
      message.error(data?.message || '请求失败');
  }
};
```

### 用户管理API

```javascript
// api/user.js
import api from './config'

export const userApi = {
  // 获取当前用户信息
  getProfile: () =>
    api.get('/admin/user/profile'),

  // 修改密码
  changePassword: (data) =>
    api.put('/admin/user/change-password', data)
};

// 使用示例
const changePassword = async (passwordData) => {
  try {
    const response = await userApi.changePassword({
      currentPassword: passwordData.currentPassword,
      newPassword: passwordData.newPassword,
      confirmPassword: passwordData.confirmPassword
    });

    if (response.data.code === 200) {
      message.success('密码修改成功，请重新登录');
      // 清除token，跳转到登录页
      localStorage.removeItem('token');
      router.push('/login');
    }
  } catch (error) {
    handleApiError(error);
  }
};
```

### Token管理增强

```javascript
// 检查token是否即将过期
const isTokenExpiringSoon = () => {
  const token = localStorage.getItem('token');
  if (!token) return true;

  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    const expTime = payload.exp * 1000;
    const now = Date.now();
    return (expTime - now) < 5 * 60 * 1000; // 5分钟内过期
  } catch {
    return true;
  }
};
```

## 注意事项

### 🔒 安全相关（新增）

1. **权限验证增强**: 所有管理员操作现在都有严格的权限验证
2. **审计日志**: 敏感操作会自动记录在安全审计日志中
3. **访问监控**: 系统会实时监控管理员API访问
4. **错误处理**: 必须正确处理403权限错误，避免用户困惑
5. **Token安全**: 建议实施token即将过期的提醒机制

### 通用注意事项

6. **Token管理**: JWT token有效期为24小时，过期后需要重新登录
7. **数据验证**: 提交数据前进行前端验证，减少服务器压力
8. **分页处理**: 注意分页参数从0开始
9. **文件上传**: 如需要文件上传功能，请查看Swagger文档
10. **批量操作**: 目前不支持批量操作，需要逐个处理

## 📋 更新日志

### v1.1 (2025-08-22) - 安全修复版本

**🔒 安全增强**:
- 新增方法级权限验证，所有管理员操作需要ADMIN角色
- 新增安全审计日志系统，记录所有敏感操作
- 新增管理员访问控制过滤器，实时监控API访问
- 分离管理员和普通用户的数据访问方法
- 新增安全监控接口

**👤 用户管理功能**:
- 新增获取当前用户信息接口 (`GET /admin/user/profile`)
- 新增管理员密码修改接口 (`PUT /admin/user/change-password`)
- 新增密码修改安全验证（当前密码验证、新密码确认等）
- 新增密码修改审计日志记录

**⚠️ 破坏性变更**:
- 无（向后兼容）

**🔧 前端适配**:
- 需要增强权限错误处理（401/403）
- 建议实施token过期检查机制
- 新增用户管理相关页面和功能
- 可选：集成安全监控界面

## 在线文档

完整的API文档可以通过以下方式查看：

- **Swagger UI**: http://localhost:8888/api/swagger-ui.html
- **OpenAPI JSON**: http://localhost:8888/api/api-docs

建议在开发过程中结合Swagger UI进行接口测试和调试。

## ✅ 前端集成检查清单

### 必须完成的修改

- [ ] **错误处理增强**: 正确处理401/403权限错误
- [ ] **请求拦截器**: 统一处理安全相关错误
- [ ] **Token管理**: 检查token过期并提醒用户
- [ ] **用户管理API**: 集成用户信息获取和密码修改功能

### 建议完成的修改

- [ ] **安全监控**: 集成安全统计信息显示
- [ ] **操作确认**: 为敏感操作添加二次确认
- [ ] **日志记录**: 记录前端操作日志
- [ ] **密码强度检查**: 前端验证新密码强度
- [ ] **密码修改后处理**: 自动清除token并跳转登录

### 测试验证

- [ ] **权限测试**: 验证非管理员用户无法访问管理接口
- [ ] **Token过期**: 测试token过期后的处理流程
- [ ] **错误处理**: 测试各种错误情况的用户体验
- [ ] **密码修改**: 测试密码修改的各种场景（成功、失败、验证错误等）
- [ ] **用户信息**: 测试用户信息获取和显示

## 🆘 技术支持

如果在集成过程中遇到问题：

1. **权限问题**: 检查用户角色是否为ADMIN
2. **Token问题**: 确认token格式和有效期
3. **安全问题**: 查看安全审计日志
4. **其他问题**: 查看应用程序日志或联系技术支持

---

**文档版本**: v1.1 (安全修复版本)
**最后更新**: 2025-08-22
**下次更新**: 根据安全审计结果确定
